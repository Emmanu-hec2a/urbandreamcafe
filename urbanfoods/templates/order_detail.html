{% extends 'base.html' %}
{% load static %}

{% block title %}Order Details - {{ order.order_number }}{% endblock %}

{% block content %}
<input type="hidden" id="orderNumber" value="{{ order.order_number }}">
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'my_orders' %}">My Orders</a></li>
                    <li class="breadcrumb-item active">{{ order.order_number }}</li>
                </ol>
            </nav>
            
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h2 mb-1 text-dark"><i class="fas fa-receipt text-primary me-2"></i>Order Details</h1>
                    <p class="text-muted mb-0">Order #{{ order.order_number }} â€¢ Placed on {{ order.created_at|date:"M d, Y H:i" }}</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row g-4">
        <!-- Status History & Items -->
        <div class="col-lg-8 d-flex flex-column gap-4">
            <!-- Status History -->
            <div class="card shadow-sm border-0 flex-grow-1">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-clock me-2"></i>Status History</h5>
                </div>
                <div class="card-body overflow-auto" style="max-height: 300px;">
                    {% if status_history %}
                    <div class="timeline">
                        {% for status in status_history %}
                        <div class="timeline-item mb-4">
                            <div class="timeline-marker bg-primary"></div>
                            <div class="timeline-content">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="mb-0 fw-bold">{{ status.status|capfirst }}</h6>
                                    <small class="text-muted">{{ status.timestamp|date:"M d, Y H:i" }}</small>
                                </div>
                                {% if status.notes %}
                                <p class="text-muted small mb-0">{{ status.notes }}</p>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-info-circle fa-2x text-muted mb-3"></i>
                        <p class="text-muted">No status updates available.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Items Ordered -->
            
            <div class="card shadow-sm border-0 flex-grow-1">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-utensils me-2"></i>Items Ordered</h5>
                </div>
                <div class="card-body overflow-auto" style="max-height: 300px;">
                    <div class="row g-3">
                        {% for item in order.items.all %}
                        <div class="col-12">
                            <div class="d-flex align-items-center p-3 border rounded hover-shadow">
                                <div class="flex-shrink-0 me-3">
                                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                        <i class="fas fa-utensil-spoon"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1">
                                    <h6 class="mb-1 fw-bold">{{ item.food_item.name }}</h6>
                                    <p class="text-muted small mb-0">Quantity: {{ item.quantity }}</p>
                                </div>
                                <div class="text-end">
                                    <span class="fw-bold text-primary">KES {{ item.price_at_order|floatformat:2 }}</span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        {% if order.status == 'delivered' %}
                        <form style="display: none;" id="foodReviewForm" method="POST" action="{% url 'submit_food_review' order.order_number %}" class="mt-3" novalidate>
                            {% csrf_token %}
                            {% for item in order.items.all %}
                            <div class="food-review-item" data-food-item-id="{{ item.food_item.id }}">
                                <label class="form-label fw-semibold">Rate {{ item.food_item.name }}</label>
                                <div class="mb-2">
                                    {% for i in "12345" %}
                                    <input type="radio" id="food-{{ item.food_item.id }}-star-{{ i }}" name="rating-{{ item.food_item.id }}" value="{{ i }}">
                                    <label for="food-{{ item.food_item.id }}-star-{{ i }}" class="me-1">&#9733;</label>
                                    {% endfor %}
                                </div>
                                <textarea name="comment" class="form-control" rows="2" placeholder="Please use a 'Rate Your Order' to submit review..."></textarea>
                            </div>
                            {% if not forloop.last %}
                            <hr class="my-3">
                            {% endif %}
                            {% endfor %}
                        </form>
                        {% endif %}
                        {% if order.status == 'delivered' %}
                        <div style="display: none;" class="col-12 mt-3">
                            <button type="submit" form="foodReviewForm" class="btn btn-primary">Submit Food Reviews</button>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Order Summary & Delivery Details -->
        <div class="col-lg-4 d-flex flex-column gap-4">
            <!-- Delivery Details -->
            <div class="card shadow-sm border-0 flex-grow-1">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-map-marker-alt me-2"></i>Delivery Details</h5>
                </div>
                <div class="card-body overflow-auto" style="max-height: 300px;">
                    <div class="mb-3">
                        <label class="form-label fw-semibold text-muted small">Hostel</label>
                        <p class="mb-2 fw-medium">{{ order.hostel }}</p>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold text-muted small">Room Number</label>
                        <p class="mb-2 fw-medium">{{ order.room_number }}</p>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold text-muted small">Phone Number</label>
                        <p class="mb-2 fw-medium">{{ order.phone_number }}</p>
                    </div>
                    {% if order.delivery_notes %}
                    <div>
                        <label class="form-label fw-semibold text-muted small">Delivery Notes</label>
                        <p class="mb-0">{{ order.delivery_notes }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Order Summary -->
            <div class="card shadow-sm border-0 flex-grow-1">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-calculator me-2"></i>Order Summary</h5>
                </div>
                <div class="card-body overflow-auto" style="max-height: 300px;">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">Subtotal</span>
                        <span class="fw-medium">KES {{ order.subtotal|floatformat:2 }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <span class="text-muted">Delivery Fee</span>
                        <span class="fw-medium">KES {{ order.delivery_fee|floatformat:2 }}</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between mb-3">
                        <span class="h5 fw-bold text-primary mb-0">Total</span>
                        <span class="h5 fw-bold text-primary mb-0">KES {{ order.total|floatformat:2 }}</span>
                    </div>
                    <div class="pt-2 border-top">
                        <div class="d-flex justify-content-between">
                            <small class="text-muted">Estimated Delivery</small>
                            <small class="fw-medium">{{ order.estimated_delivery|date:"M d, Y H:i" }}</small>
                        </div>
                    </div>
                </div>
            </div>
            {% if order.status == 'delivered' and not order.rating %}
            <div class="card shadow-sm border-0 mt-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-star me-2"></i>Rate Your Order</h5>
                </div>
                <div class="card-body">
                    <form id="foodReviewForm" method="POST" action="{% url 'submit_food_review' order.order_number %}" class="mt-3" novalidate>
                        {% csrf_token %} 
                        {% for item in order.items.all %} 
                        <div class="food-review-item" data-food-item-id="{{ item.food_item.id }}"> 
                            <label class="form-label fw-semibold">Rate {{ item.food_item.name }}</label> 
                            <div class="mb-2"> 
                                {% for i in "12345" %} 
                                <input type="radio" id="food-{{ item.food_item.id }}-star-{{ i }}" name="rating-{{ item.food_item.id }}" value="{{ i }}"> 
                                <label for="food-{{ item.food_item.id }}-star-{{ i }}" class="me-1">&#9733;</label> 
                                {% endfor %} 
                            </div> 
                            <textarea name="comment-{{ item.food_item.id }}" class="form-control" rows="2" placeholder="Write a review (optional)"></textarea> 
                        </div> 
                        {% if not forloop.last %} 
                        <hr class="my-3"> 
                        {% endif %} {% endfor %} 
                            <button type="submit" class="btn btn-primary mt-3">Submit Food Reviews</button> 
                    </form>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
.hover-shadow {
    transition: box-shadow 0.3s ease;
}
.hover-shadow:hover {
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
}

.timeline {
    position: relative;
    padding-left: 30px;
}

.timeline::before {
    content: '';
    position: absolute;
    left: 15px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #e9ecef;
}

.timeline-item {
    position: relative;
    margin-bottom: 20px;
}

.timeline-marker {
    position: absolute;
    left: -22px;
    top: 5px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid #fff;
    box-shadow: 0 0 0 2px #007bff;
}

.timeline-content {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    border-left: 4px solid #007bff;
}

/* Dark theme support */
[data-bs-theme="dark"] {
    background-color: #1a1a1a;
    color: #e5e5e5;
}
[data-bs-theme="dark"] .bg-gray-50 {
    background-color: #1a1a1a !important;
}
[data-bs-theme="dark"] .bg-white {
    background-color: #2d2d2d !important;
}
[data-bs-theme="dark"] .text-gray-600 {
    color: #b3b3b3 !important;
}
[data-bs-theme="dark"] .text-gray-500 {
    color: #a3a3a3 !important;
}
[data-bs-theme="dark"] .text-gray-700 {
    color: #d1d1d1 !important;
}
[data-bs-theme="dark"] .text-gray-400 {
    color: #9ca3af !important;
}
[data-bs-theme="dark"] .text-dark {
    color: #e0e0e0 !important;
}
[data-bs-theme="dark"] .text-muted {
    color: #a0a0a0 !important;
}
[data-bs-theme="dark"] .text-primary {
    color: #f97316 !important; /* orange-600 */
}
[data-bs-theme="dark"] .text-warning {
    color: #fbbf24 !important; /* yellow-400 */
}
[data-bs-theme="dark"] .border-gray-200 {
    border-color: #404040 !important;
}
[data-bs-theme="dark"] .border-gray-300 {
    border-color: #555 !important;
}
[data-bs-theme="dark"] .shadow-md {
    box-shadow: 0 4px 6px -1px rgba(255, 255, 255, 0.1), 0 2px 4px -1px rgba(255, 255, 255, 0.06) !important;
}
[data-bs-theme="dark"] .shadow-lg {
    box-shadow: 0 10px 15px -3px rgba(255, 255, 255, 0.1), 0 4px 6px -2px rgba(255, 255, 255, 0.05) !important;
}
[data-bs-theme="dark"] .shadow-2xl {
    box-shadow: 0 25px 50px -12px rgba(255, 255, 255, 0.25) !important;
}
[data-bs-theme="dark"] .bg-light {
    background-color: #2c2c2c !important;
}
[data-bs-theme="dark"] .timeline-content {
    background: #2c2c2c !important;
    border-left-color: #f97316 !important;
}
[data-bs-theme="dark"] .timeline::before {
    background: #444 !important;
}
[data-bs-theme="dark"] .badge.bg-secondary {
    background-color: #444 !important;
    color: #ccc !important;
}
[data-bs-theme="dark"] .badge.bg-success {
    background-color: #22c55e !important; /* green-500 */
    color: #f0fdf4 !important;
}
[data-bs-theme="dark"] .badge.bg-danger {
    background-color: #ef4444 !important; /* red-500 */
    color: #fef2f2 !important;
}
[data-bs-theme="dark"] .btn-outline-primary {
    color: #f97316 !important;
    border-color: #f97316 !important;
}
[data-bs-theme="dark"] .btn-outline-primary:hover {
    background-color: #f97316 !important;
    color: #fff !important;
}
[data-bs-theme="dark"] .text-red-500 {
    color: #ef4444 !important;
}
[data-bs-theme="dark"] .hover\:text-red-700:hover {
    color: #f87171 !important;
}
[data-bs-theme="dark"] .bg-gray-200 {
    background-color: #555 !important;
}
[data-bs-theme="dark"] .hover\:bg-gray-300:hover {
    background-color: #666 !important;
}
</style>

<script src="{% static 'js/order_detail.js' %}"></script>
{% endblock %}

